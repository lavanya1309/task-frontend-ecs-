name: CI/CD Frontend - ECS EC2 Deploy

on:
  push:
    branches:
      - main

  workflow_dispatch:
    inputs:
      action:
        description: 'Terraform Action'
        required: true
        default: 'apply'
        type: choice
        options:
          - plan
          - apply
          - destroy

env:
  AWS_REGION: us-east-1
  APP_NAME: lms-frontend
  DOCKER_USERNAME: somasekar1309
  REPO_NAME: testingpipline-lms-frontend
  DYNAMODB_TABLE: terraform-locks
  STATE_LOCK_ID: ecs/terraform.tfstate

jobs:
  terraform:
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ§¾ Checkout code
      uses: actions/checkout@v3

    - name: ğŸ·ï¸ Set Docker image version tag
      run: |
        VERSION_TAG="v$(git rev-list --count HEAD)"
        echo "VERSION_TAG=$VERSION_TAG" >> $GITHUB_ENV
        echo "DOCKER_IMAGE=$DOCKER_USERNAME/$REPO_NAME:$VERSION_TAG" >> $GITHUB_ENV
        echo "DOCKER_IMAGE_LATEST=$DOCKER_USERNAME/$REPO_NAME:latest" >> $GITHUB_ENV

    - name: âš™ï¸ Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    - name: ğŸ“¦ Install dependencies
      run: npm ci

    - name: ğŸ› ï¸ Build React frontend
      run: npm run build

    - name: ğŸ“„ Create .dockerignore
      run: |
        echo "node_modules" > .dockerignore
        echo "terraform" >> .dockerignore
        echo ".github" >> .dockerignore

    - name: ğŸ³ Log in to Docker Hub
      run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

    - name: ğŸ³ Build Docker image
      run: |
        docker build -t $DOCKER_IMAGE .
        docker tag $DOCKER_IMAGE $DOCKER_IMAGE_LATEST

    - name: ğŸš€ Push Docker images
      run: |
        docker push $DOCKER_IMAGE
        docker push $DOCKER_IMAGE_LATEST

    - name: ğŸ“Š SonarQube Scan
      uses: sonarsource/sonarqube-scan-action@v1.0.0
      with:
        projectBaseDir: .
      env:
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}

    - name: âš™ï¸ Setup Terraform
      uses: hashicorp/setup-terraform@v2
      with:
        terraform_version: 1.6.6

    - name: ğŸ” Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: ğŸ§¹ Remove stuck DynamoDB lock (if any)
      run: |
        aws dynamodb delete-item \
          --table-name $DYNAMODB_TABLE \
          --key "{\"LockID\": {\"S\": \"$STATE_LOCK_ID\"}}" \
          --region $AWS_REGION || true

    - name: ğŸ§± Terraform Init
      working-directory: terraform
      run: terraform init -input=false

    - name: ğŸ”„ Terraform Import Existing IAM Resources
      working-directory: terraform
      run: |
        terraform import aws_iam_role.ecs_instance_role react-frontend1-ecs-instance-role || true
        terraform import aws_iam_role.ecs_task_execution_role react-frontend1-task-execution-role || true
        terraform import aws_iam_instance_profile.ecs_instance_profile react-frontend1-ecs-instance-profile || true

    - name: ğŸ“‹ Terraform Plan
      if: github.event.inputs.action == 'plan'
      working-directory: terraform
      run: terraform plan -var="docker_image=$DOCKER_IMAGE_LATEST"

    - name: ğŸš€ Terraform Apply
      if: github.event.inputs.action == 'apply'
      working-directory: terraform
      run: terraform apply -auto-approve -var="docker_image=$DOCKER_IMAGE_LATEST"

    - name: ğŸ’£ Terraform Destroy
      if: github.event.inputs.action == 'destroy'
      working-directory: terraform
      run: terraform destroy -auto-approve -var="docker_image=$DOCKER_IMAGE_LATEST"
